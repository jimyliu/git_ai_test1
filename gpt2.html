<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AI Image Frame Tool ‚Äî 2025-12-30 22:47:58</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --panel2:#0d1730;
      --text:#e9eefc;
      --muted:#aab6da;
      --line:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow2: 0 6px 20px rgba(0,0,0,.28);
      --radius: 16px;
      --radius2: 12px;
      --gap: 14px;
      --accent: #7aa2ff;
      --danger:#ff6b6b;
      --ok:#27d9a3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(122,162,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, rgba(39,217,163,.18), transparent 55%),
                  linear-gradient(180deg, #081025, #060b16);
      color:var(--text);
    }
    .topbar{
      position:sticky; top:0; z-index:20;
      background: rgba(6,11,22,.75);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{
      max-width: 1400px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .title-wrap{
      display:flex; flex-direction:column; gap:2px;
      min-width: 240px;
    }
    .tool-title{
      font-size: 15px;
      font-weight: 700;
      letter-spacing: .2px;
      line-height: 1.2;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .subnote{
      font-size: 12px;
      color: var(--muted);
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow2);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background: var(--ok); box-shadow:0 0 0 3px rgba(39,217,163,.15)}
    .app{
      max-width: 1400px;
      margin: 0 auto;
      padding: 14px 16px 18px;
    }
    .grid{
      display:grid;
      grid-template-columns: 360px minmax(320px, 1fr) 360px;
      gap: var(--gap);
      align-items:start;
    }
    .panel{
      background: rgba(15,27,51,.72);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-header{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .panel-title{
      font-weight: 800;
      font-size: 13px;
      letter-spacing: .2px;
    }
    .panel-body{
      padding: 12px 14px 14px;
    }

    .section{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);
      background: rgba(13,23,48,.55);
      overflow:hidden;
      margin-bottom: 12px;
    }
    .section:last-child{margin-bottom:0}
    .section-h{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .section-h .h{
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .25px;
      color: #dbe6ff;
      display:flex; align-items:center; gap:8px;
    }
    .badge{
      font-size: 11px;
      color: var(--muted);
      padding: 4px 8px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }
    .section-b{ padding: 10px 12px 12px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .row.one{ grid-template-columns: 1fr; }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="text"], input[type="number"], select{
      width:100%;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
    }
    input[type="text"]::placeholder{ color: rgba(233,238,252,.45) }
    input[type="color"]{
      width:100%;
      height: 38px;
      padding: 0;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      background: rgba(0,0,0,.22);
      cursor:pointer;
    }
    input[type="range"]{ width:100% }
    .help{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(233,238,252,.68);
      line-height: 1.35;
    }
    .help b{ color:#ffffff }
    .btns{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .btn{
      flex: 1 1 auto;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 800;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      box-shadow: 0 8px 18px rgba(0,0,0,.24);
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.20) }
    .btn:active{ transform: translateY(1px) }
    .btn.primary{
      background: rgba(122,162,255,.20);
      border-color: rgba(122,162,255,.35);
    }
    .btn.danger{
      background: rgba(255,107,107,.14);
      border-color: rgba(255,107,107,.28);
    }

    .center{
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      align-items:stretch;
    }
    .canvas-wrap{
      background: rgba(15,27,51,.72);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .canvas-meta{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap: wrap;
    }
    .canvas-meta .left{
      display:flex; align-items:center; gap:10px; flex-wrap: wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .kv{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }
    .canvas-stage{
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.18);
      background: radial-gradient(800px 400px at 50% 50%, rgba(255,255,255,.06), rgba(255,255,255,.02));
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 420px;
    }
    canvas{
      max-width: 100%;
      width: 100%;
      height: auto;
      border-radius: 12px;
      background: rgba(0,0,0,.18);
      touch-action: none; /* critical for iOS dragging */
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      color: #fff;
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 12px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
      max-width: calc(100vw - 24px);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    .mini{
      font-size: 11px;
      color: rgba(233,238,252,.68);
      margin-top: 8px;
      line-height: 1.35;
    }
    .divider{
      height: 1px;
      background: rgba(255,255,255,.10);
      margin: 10px 0;
    }
    .hint{
      font-size: 12px;
      color: rgba(233,238,252,.70);
      line-height: 1.35;
    }
    .hint kbd{
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size: 11px;
      padding: 2px 6px;
      border: 1px solid rgba(255,255,255,.16);
      border-bottom-width: 2px;
      border-radius: 8px;
      background: rgba(255,255,255,.06);
      color: #fff;
      white-space: nowrap;
    }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }

    @media (max-width: 1180px){
      .grid{ grid-template-columns: 320px minmax(280px,1fr) 320px; }
    }
    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .panel{ order: 1; }
      .center{ order: 0; }
      .canvas-stage{ min-height: 340px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="title-wrap">
        <div class="tool-title" id="visibleTitle">AI Image Frame Tool ‚Äî 2025-12-30 22:47:58</div>
        <div class="subnote">Browser-only ‚Ä¢ Safari + Chrome compatible ‚Ä¢ Canvas multi-layer renderer</div>
      </div>
      <div class="chip" title="Everything runs in your browser. No backend.">
        <span class="dot"></span>
        <span>Layer order locked: Background ‚Üí Main ‚Üí Frame ‚Üí Title ‚Üí Subtitle</span>
      </div>
    </div>
  </div>

  <div class="app">
    <div class="grid">
      <!-- LEFT CONTROLS -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Layers ‚Ä¢ Images</div>
          <span class="badge">Left</span>
        </div>
        <div class="panel-body">

          <div class="section">
            <div class="section-h">
              <div class="h">üåÑ Background Image Layer</div>
              <span class="badge" id="bgStatus">Not loaded</span>
            </div>
            <div class="section-b">
              <div class="row one">
                <div>
                  <label>Load background image</label>
                  <input id="bgFile" type="file" accept="image/*" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Background Fit</label>
                  <select id="bgFit">
                    <option value="cover">Cover (fill canvas)</option>
                    <option value="contain">Contain (no crop)</option>
                  </select>
                </div>
                <div>
                  <label>Background Transparency (20% ‚Üí 100%)</label>
                  <input id="bgTrans" type="range" min="20" max="100" value="35" />
                  <div class="mini"><span class="mono" id="bgTransVal">35%</span> (higher = more transparent)</div>
                </div>
              </div>

              <div class="btns">
                <button class="btn danger" id="bgClear" type="button">Clear Background</button>
                <button class="btn" id="bgAutoTheme" type="button" title="Quick preset colors & captions">Holiday Preset</button>
              </div>

              <div class="help">
                Background is <b>not draggable</b> by default. Opacity controls affect <b>only</b> the background layer.
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-h">
              <div class="h">üñº Main Image Layer</div>
              <span class="badge" id="mainStatus">Not loaded</span>
            </div>
            <div class="section-b">
              <div class="row one">
                <div>
                  <label>Load main image (photo / portrait)</label>
                  <input id="mainFile" type="file" accept="image/*" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Main Transparency (0% ‚Üí 100%)</label>
                  <input id="mainTrans" type="range" min="0" max="100" value="0" />
                  <div class="mini"><span class="mono" id="mainTransVal">0%</span> (higher = more transparent)</div>
                </div>
                <div>
                  <label>Main Scale (10% ‚Üí 200%)</label>
                  <input id="mainScale" type="range" min="10" max="200" value="100" />
                  <div class="mini"><span class="mono" id="mainScaleVal">100%</span></div>
                </div>
              </div>

              <div class="btns">
                <button class="btn" id="mainCenter" type="button">Auto-center Main</button>
                <button class="btn danger" id="mainClear" type="button">Clear Main</button>
              </div>

              <div class="help">
                Drag on the canvas to move the <b>main image + frame together</b>.
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-h">
              <div class="h">üñº Frame / Border</div>
              <span class="badge">wraps main image</span>
            </div>
            <div class="section-b">
              <div class="row">
                <div>
                  <label>Frame Color</label>
                  <input id="frameColor" type="color" value="#ffffff" />
                </div>
                <div>
                  <label>Frame Thickness</label>
                  <input id="frameThickness" type="range" min="1" max="80" value="14" />
                  <div class="mini"><span class="mono" id="frameThickVal">14</span> px</div>
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Frame Padding</label>
                  <input id="framePad" type="range" min="0" max="120" value="24" />
                  <div class="mini"><span class="mono" id="framePadVal">24</span> px</div>
                </div>
                <div>
                  <label>Frame Visibility</label>
                  <select id="frameOn">
                    <option value="on">On</option>
                    <option value="off">Off</option>
                  </select>
                </div>
              </div>

              <div class="help">
                Frame thickness is <b>uniform</b> on all sides and always follows the main image.
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-h">
              <div class="h">üß† AI-like Enhancements</div>
              <span class="badge">browser-only</span>
            </div>
            <div class="section-b">
              <div class="row">
                <div>
                  <label>Preset Captions</label>
                  <select id="presetCaptions">
                    <option value="">(choose)</option>
                    <option value="Peace on Earth|Joy to the World">Peace on Earth / Joy to the World</option>
                    <option value="Merry Christmas|Warmest Wishes">Merry Christmas / Warmest Wishes</option>
                    <option value="Hope|Love & Light">Hope / Love & Light</option>
                    <option value="Be Still|and know that I am God">Be Still / and know that I am God</option>
                    <option value="‰∏ÄËµ∑Âä†Ê≤πÂä†Ê≤π!!!|Á•ùÁ¶èÊªøÊªø">‰∏ÄËµ∑Âä†Ê≤πÂä†Ê≤π!!! / Á•ùÁ¶èÊªøÊªø</option>
                    <option value="Thanks for everything|Pray for everything">Thanks / Pray</option>
                  </select>
                </div>
                <div>
                  <label>Apply Preset To</label>
                  <select id="presetTarget">
                    <option value="both">Title + Subtitle</option>
                    <option value="title">Title only</option>
                    <option value="subtitle">Subtitle only</option>
                  </select>
                </div>
              </div>
              <div class="btns">
                <button class="btn primary" id="applyPreset" type="button">Apply Preset</button>
                <button class="btn" id="randomStyle" type="button">Random Style</button>
              </div>
              <div class="help">
                Auto-centers content on load and picks smart defaults. Random Style tweaks font, size, and colors ‚Äî all in-browser.
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- CENTER CANVAS -->
      <div class="center">
        <div class="canvas-wrap">
          <div class="canvas-meta">
            <div class="left">
              <span class="kv">Canvas: <span class="mono" id="canvasSizeLabel">1080√ó1080</span></span>
              <span class="kv">Drag: <span class="mono">Main / Title / Subtitle</span></span>
              <span class="kv">Export: <span class="mono">PNG</span></span>
            </div>
            <div class="btns" style="margin:0; justify-content:flex-end;">
              <button class="btn" id="resetAll" type="button">Reset</button>
              <button class="btn primary" id="downloadPng" type="button">Download PNG</button>
            </div>
          </div>

          <div class="canvas-stage">
            <canvas id="c" width="1080" height="1080" aria-label="Canvas Preview"></canvas>
          </div>

          <div class="hint">
            Tip: Drag directly on the canvas (mouse or touch). Layer priority: <kbd>Main</kbd> first, then <kbd>Title</kbd>, then <kbd>Subtitle</kbd>.
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Canvas Settings</div>
            <span class="badge">Middle</span>
          </div>
          <div class="panel-body">
            <div class="row">
              <div>
                <label>Canvas Width (px)</label>
                <input id="canvasW" type="number" min="256" max="6000" value="1080" />
              </div>
              <div>
                <label>Canvas Height (px)</label>
                <input id="canvasH" type="number" min="256" max="6000" value="1080" />
              </div>
            </div>
            <div class="btns">
              <button class="btn" id="applyCanvasSize" type="button">Apply Canvas Size</button>
              <button class="btn" id="snapSquare" type="button">Quick 1080√ó1080</button>
            </div>
            <div class="mini">
              Export is pixel-perfect at the canvas size shown above.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT CONTROLS -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Layers ‚Ä¢ Text</div>
          <span class="badge">Right</span>
        </div>
        <div class="panel-body">

          <div class="section">
            <div class="section-h">
              <div class="h">‚úçÔ∏è Title Text Layer</div>
              <span class="badge">draggable</span>
            </div>
            <div class="section-b">

              <div class="row one">
                <div>
                  <label>Title Text (real-time)</label>
                  <input id="titleText" type="text" placeholder="Enter title..." value="Merry Christmas" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Title Font Family (macOS Safari safe)</label>
                  <select id="titleFont"></select>
                </div>
                <div>
                  <label>Title Size (14pt ‚Üí 800pt)</label>
                  <input id="titleSize" type="number" min="14" max="800" value="92" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Title Text Color</label>
                  <input id="titleColor" type="color" value="#ffffff" />
                </div>
                <div>
                  <label>Title BG Color</label>
                  <input id="titleBgColor" type="color" value="#000000" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Title BG Transparency (0% ‚Üí 100%)</label>
                  <input id="titleBgTrans" type="range" min="0" max="100" value="70" />
                  <div class="mini"><span class="mono" id="titleBgTransVal">70%</span> (higher = more transparent)</div>
                </div>
                <div>
                  <label>Title Auto Center</label>
                  <button class="btn" id="titleCenter" type="button" style="width:100%;">Center Title</button>
                </div>
              </div>

              <div class="help">
                Drag the title directly on the canvas. Default alignment is <b>center</b>.
              </div>

            </div>
          </div>

          <div class="section">
            <div class="section-h">
              <div class="h">‚úçÔ∏è Subtitle Text Layer</div>
              <span class="badge">draggable</span>
            </div>
            <div class="section-b">

              <div class="row one">
                <div>
                  <label>Subtitle Text (real-time)</label>
                  <input id="subtitleText" type="text" placeholder="Enter subtitle..." value="Warmest Wishes" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Subtitle Font Family (macOS Safari safe)</label>
                  <select id="subtitleFont"></select>
                </div>
                <div>
                  <label>Subtitle Size (14pt ‚Üí 800pt)</label>
                  <input id="subtitleSize" type="number" min="14" max="800" value="48" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Subtitle Text Color</label>
                  <input id="subtitleColor" type="color" value="#ffffff" />
                </div>
                <div>
                  <label>Subtitle BG Color</label>
                  <input id="subtitleBgColor" type="color" value="#000000" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Subtitle BG Transparency (0% ‚Üí 100%)</label>
                  <input id="subtitleBgTrans" type="range" min="0" max="100" value="78" />
                  <div class="mini"><span class="mono" id="subtitleBgTransVal">78%</span> (higher = more transparent)</div>
                </div>
                <div>
                  <label>Subtitle Auto Center</label>
                  <button class="btn" id="subtitleCenter" type="button" style="width:100%;">Center Subtitle</button>
                </div>
              </div>

              <div class="help">
                Subtitle is always rendered <b>above</b> the main image and frame.
              </div>

            </div>
          </div>

          <div class="section">
            <div class="section-h">
              <div class="h">üì§ Export</div>
              <span class="badge">pixel-perfect</span>
            </div>
            <div class="section-b">
              <div class="btns">
                <button class="btn primary" id="downloadPng2" type="button">Download PNG</button>
                <button class="btn" id="copyInfo" type="button">Copy Settings</button>
              </div>
              <div class="divider"></div>
              <div class="mini" id="copyDump" style="display:none;"></div>
              <div class="help">
                Export includes background, main image, opacity levels, frame, and text positions ‚Äî exactly as shown.
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast">Saved</div>

  <script>
  (function(){
    // ====== Version / Timestamp (MUST be generation time, not dynamic) ======
    const GENERATION_TS = "2025-12-30 22:47:58"; // visible + <title> already include this

    // ====== Canvas setup (HiDPI) ======
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d', { alpha: true });

    function dpr(){
      return Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    }

    function setCanvasSize(w, h){
      // Keep internal canvas at exact pixel size (for export)
      canvas.width = Math.round(w);
      canvas.height = Math.round(h);
      document.getElementById('canvasSizeLabel').textContent = `${canvas.width}√ó${canvas.height}`;
      render();
    }

    // ====== UI elements ======
    const ui = {
      // Background
      bgFile: document.getElementById('bgFile'),
      bgFit: document.getElementById('bgFit'),
      bgTrans: document.getElementById('bgTrans'),
      bgTransVal: document.getElementById('bgTransVal'),
      bgStatus: document.getElementById('bgStatus'),
      bgClear: document.getElementById('bgClear'),
      bgAutoTheme: document.getElementById('bgAutoTheme'),

      // Main
      mainFile: document.getElementById('mainFile'),
      mainTrans: document.getElementById('mainTrans'),
      mainTransVal: document.getElementById('mainTransVal'),
      mainScale: document.getElementById('mainScale'),
      mainScaleVal: document.getElementById('mainScaleVal'),
      mainStatus: document.getElementById('mainStatus'),
      mainCenter: document.getElementById('mainCenter'),
      mainClear: document.getElementById('mainClear'),

      // Frame
      frameColor: document.getElementById('frameColor'),
      frameThickness: document.getElementById('frameThickness'),
      frameThickVal: document.getElementById('frameThickVal'),
      framePad: document.getElementById('framePad'),
      framePadVal: document.getElementById('framePadVal'),
      frameOn: document.getElementById('frameOn'),

      // Text - Title
      titleText: document.getElementById('titleText'),
      titleFont: document.getElementById('titleFont'),
      titleSize: document.getElementById('titleSize'),
      titleColor: document.getElementById('titleColor'),
      titleBgColor: document.getElementById('titleBgColor'),
      titleBgTrans: document.getElementById('titleBgTrans'),
      titleBgTransVal: document.getElementById('titleBgTransVal'),
      titleCenter: document.getElementById('titleCenter'),

      // Text - Subtitle
      subtitleText: document.getElementById('subtitleText'),
      subtitleFont: document.getElementById('subtitleFont'),
      subtitleSize: document.getElementById('subtitleSize'),
      subtitleColor: document.getElementById('subtitleColor'),
      subtitleBgColor: document.getElementById('subtitleBgColor'),
      subtitleBgTrans: document.getElementById('subtitleBgTrans'),
      subtitleBgTransVal: document.getElementById('subtitleBgTransVal'),
      subtitleCenter: document.getElementById('subtitleCenter'),

      // AI enhancements
      presetCaptions: document.getElementById('presetCaptions'),
      presetTarget: document.getElementById('presetTarget'),
      applyPreset: document.getElementById('applyPreset'),
      randomStyle: document.getElementById('randomStyle'),

      // Canvas settings
      canvasW: document.getElementById('canvasW'),
      canvasH: document.getElementById('canvasH'),
      applyCanvasSize: document.getElementById('applyCanvasSize'),
      snapSquare: document.getElementById('snapSquare'),

      // Export / actions
      downloadPng: document.getElementById('downloadPng'),
      downloadPng2: document.getElementById('downloadPng2'),
      resetAll: document.getElementById('resetAll'),
      copyInfo: document.getElementById('copyInfo'),
      copyDump: document.getElementById('copyDump'),

      toast: document.getElementById('toast')
    };

    // ====== Fonts (Order MUST match exactly) ======
    const FONT_OPTIONS = [
      // Traditional Chinese Fonts (ÁπÅÈ´î‰∏≠Êñá) ‚Äî must remain available for BOTH Title & Subtitle
      { label: 'PingFang TCÔºàËòãÊñπ-ÁπÅÔºâ‚Äî ‚≠ê Primary', value: '"PingFang TC","PingFangTC-Regular","PingFangTC-Medium","PingFangTC-Semibold","Heiti TC",system-ui,sans-serif' },
      { label: 'PingFang TC', value: '"PingFang TC","PingFangTC-Regular","Heiti TC",system-ui,sans-serif' },
      { label: 'PingFangTC-Regular', value: '"PingFangTC-Regular","PingFang TC","Heiti TC",system-ui,sans-serif' },
      { label: 'PingFangTC-Medium', value: '"PingFangTC-Medium","PingFang TC","Heiti TC",system-ui,sans-serif' },
      { label: 'PingFangTC-Semibold', value: '"PingFangTC-Semibold","PingFang TC","Heiti TC",system-ui,sans-serif' },
      { label: 'Heiti TCÔºàÈªëÈ´î-ÁπÅÔºâ', value: '"Heiti TC","Heiti TC Medium","Heiti TC Light","PingFang TC",system-ui,sans-serif' },
      { label: 'Heiti TC', value: '"Heiti TC","PingFang TC",system-ui,sans-serif' },
      { label: 'Heiti TC Light', value: '"Heiti TC Light","Heiti TC","PingFang TC",system-ui,sans-serif' },
      { label: 'Heiti TC Medium', value: '"Heiti TC Medium","Heiti TC","PingFang TC",system-ui,sans-serif' },
      { label: 'Songti TCÔºàÂÆãÈ´î-ÁπÅÔºâ', value: '"Songti TC","Songti TC Regular","Songti TC Bold","PingFang TC",system-ui,serif' },
      { label: 'Songti TC', value: '"Songti TC","PingFang TC",system-ui,serif' },
      { label: 'Songti TC Regular', value: '"Songti TC Regular","Songti TC","PingFang TC",system-ui,serif' },
      { label: 'Songti TC Bold', value: '"Songti TC Bold","Songti TC","PingFang TC",system-ui,serif' },
      { label: 'Kaiti TCÔºàÊ•∑È´î-ÁπÅÔºâ', value: '"Kaiti TC","Songti TC","PingFang TC",system-ui,serif' },
      { label: 'Kaiti TC', value: '"Kaiti TC","Songti TC","PingFang TC",system-ui,serif' },
      // Latin / System Fonts
      { label: 'system-ui', value: 'system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif' },
      { label: 'Arial', value: 'Arial,system-ui,sans-serif' },
      { label: 'Helvetica', value: 'Helvetica,Arial,system-ui,sans-serif' },
    ];

    function populateFonts(selectEl){
      selectEl.innerHTML = '';
      for (const opt of FONT_OPTIONS){
        const o = document.createElement('option');
        o.textContent = opt.label;
        o.value = opt.value;
        selectEl.appendChild(o);
      }
    }
    populateFonts(ui.titleFont);
    populateFonts(ui.subtitleFont);

    // Default fonts (Primary)
    ui.titleFont.value = FONT_OPTIONS[0].value;
    ui.subtitleFont.value = FONT_OPTIONS[0].value;

    // ====== State ======
    const state = {
      bg: {
        img: null,
        fit: 'cover',
        transparency: 35, // 20..100 (higher = more transparent)
      },
      main: {
        img: null,
        transparency: 20, // 20..100 (higher = more transparent)
        scalePct: 100,    // 10..200
        x: 540,
        y: 540,
        baseW: 0, // computed display size at scalePct=100
        baseH: 0
      },
      frame: {
        on: true,
        color: '#ffffff',
        thickness: 14,
        pad: 24
      },
      title: {
        text: 'Merry Christmas',
        font: ui.titleFont.value,
        size: 92,
        color: '#ffffff',
        bgColor: '#000000',
        bgTrans: 70, // 0..100 (higher = more transparent)
        x: 540,
        y: 160,
        rect: null
      },
      subtitle: {
        text: 'Warmest Wishes',
        font: ui.subtitleFont.value,
        size: 48,
        color: '#ffffff',
        bgColor: '#000000',
        bgTrans: 78,
        x: 540,
        y: 260,
        rect: null
      },
      dragging: {
        active: false,
        target: null, // 'main' | 'title' | 'subtitle' | null
        pointerId: null,
        startX: 0,
        startY: 0,
        origX: 0,
        origY: 0
      }
    };

    // ====== Utilities ======
    function toast(msg){
      ui.toast.textContent = msg;
      ui.toast.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>ui.toast.classList.remove('show'), 1400);
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function parseTransparencyToAlpha(transPct){
      // Spec: higher percentage means more transparency
      // transparency 20% => alpha 0.80, 100% => alpha 0.00
      return clamp(1 - (transPct/100), 0, 1);
    }

    function parseBgTransToAlpha(transPct){
      // 0..100; higher = more transparent
      return clamp(1 - (transPct/100), 0, 1);
    }

    function hexToRgb(hex){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      if(!m) return {r:0,g:0,b:0};
      return { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) };
    }

    function rgba(hex, alpha){
      const {r,g,b} = hexToRgb(hex);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function getCanvasPointFromEvent(ev){
      const rect = canvas.getBoundingClientRect();
      const x = (ev.clientX - rect.left) * (canvas.width / rect.width);
      const y = (ev.clientY - rect.top) * (canvas.height / rect.height);
      return {x, y};
    }

    function fitRect(imgW, imgH, boxW, boxH, mode){
      // returns {w,h, x,y} for drawing into box (0..boxW/boxH) centered
      const rImg = imgW / imgH;
      const rBox = boxW / boxH;
      let w, h;
      if(mode === 'contain'){
        if(rImg > rBox){ w = boxW; h = boxW / rImg; }
        else { h = boxH; w = boxH * rImg; }
      }else{ // cover
        if(rImg > rBox){ h = boxH; w = boxH * rImg; }
        else { w = boxW; h = boxW / rImg; }
      }
      const x = (boxW - w) / 2;
      const y = (boxH - h) / 2;
      return {w,h,x,y};
    }

    function computeSmartDefaults(){
      const w = canvas.width, h = canvas.height;

      // Title + Subtitle positions
      state.title.x = w/2;
      state.subtitle.x = w/2;

      // Smart default sizing by canvas
      state.title.size = clamp(Math.round(Math.min(w, h) * 0.085), 14, 800);
      state.subtitle.size = clamp(Math.round(Math.min(w, h) * 0.045), 14, 800);

      // Place text near top with spacing
      state.title.y = Math.round(h * 0.15);
      state.subtitle.y = Math.round(h * 0.24);

      // Center main image
      state.main.x = w/2;
      state.main.y = h/2;

      // If main image loaded: compute base size to fit nicely
      if(state.main.img){
        computeMainBaseSize();
      }

      syncUIFromState();
      render();
    }

    function computeMainBaseSize(){
      if(!state.main.img) return;
      const w = canvas.width, h = canvas.height;

      // Fit main image within canvas with margins so there is room for text
      const topSafe = Math.round(h * 0.30);
      const bottomSafe = Math.round(h * 0.06);
      const usableH = Math.max(200, h - topSafe - bottomSafe);
      const usableW = Math.max(200, Math.round(w * 0.92));

      const f = fitRect(state.main.img.naturalWidth, state.main.img.naturalHeight, usableW, usableH, 'contain');
      // baseW/baseH are the "100%" size
      state.main.baseW = Math.round(f.w);
      state.main.baseH = Math.round(f.h);

      // If we haven't moved it, center inside canvas
      state.main.x = w/2;
      state.main.y = topSafe + usableH/2;
    }

    function mainDrawRect(){
      if(!state.main.img) return null;
      const s = state.main.scalePct / 100;
      const w = state.main.baseW * s;
      const h = state.main.baseH * s;
      return { x: state.main.x - w/2, y: state.main.y - h/2, w, h };
    }

    function updateTextRect(which){
      const t = state[which];
      const paddingX = Math.max(10, Math.round(t.size * 0.25));
      const paddingY = Math.max(8, Math.round(t.size * 0.18));
      ctx.save();
      ctx.font = `${t.size}px ${t.font}`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const metrics = ctx.measureText(t.text || " ");
      const textW = metrics.width;
      const textH = Math.round(t.size * 1.18);
      const w = Math.round(textW + paddingX * 2);
      const h = Math.round(textH + paddingY * 2);
      const x = Math.round(t.x - w/2);
      const y = Math.round(t.y - h/2);
      ctx.restore();
      t.rect = {x, y, w, h};
      return t.rect;
    }

    function pointInRect(px, py, r){
      return r && px >= r.x && px <= r.x + r.w && py >= r.y && py <= r.y + r.h;
    }

    // ====== Rendering (Layer Order MUST NOT break) ======
    function render(){
      const W = canvas.width, H = canvas.height;

      // Clear
      ctx.clearRect(0, 0, W, H);

      // Optional subtle base background so transparent PNG looks ok while editing
      ctx.save();
      ctx.fillStyle = 'rgba(0,0,0,0.0)';
      ctx.fillRect(0,0,W,H);
      ctx.restore();

      // 1) Background Image Layer (BOTTOM)
      if(state.bg.img){
        const alpha = parseTransparencyToAlpha(state.bg.transparency);
        const r = fitRect(state.bg.img.naturalWidth, state.bg.img.naturalHeight, W, H, state.bg.fit);
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(state.bg.img, r.x, r.y, r.w, r.h);
        ctx.restore();
      }

      // 2) Main Image Layer
      if(state.main.img){
        const alpha = parseTransparencyToAlpha(state.main.transparency);
        const r = mainDrawRect();
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(state.main.img, r.x, r.y, r.w, r.h);
        ctx.restore();

        // 3) Frame / Border Layer (wrap main image only)
        if(state.frame.on){
          const pad = state.frame.pad;
          const fx = r.x - pad;
          const fy = r.y - pad;
          const fw = r.w + pad*2;
          const fh = r.h + pad*2;

          ctx.save();
          ctx.strokeStyle = state.frame.color;
          ctx.lineWidth = state.frame.thickness;
          ctx.lineJoin = 'miter';
          ctx.lineCap = 'butt';
          // keep crisp: draw at half-pixel alignment for odd lineWidth
          const adj = (state.frame.thickness % 2) ? 0.5 : 0;
          ctx.strokeRect(Math.round(fx)+adj, Math.round(fy)+adj, Math.round(fw), Math.round(fh));
          ctx.restore();
        }
      }

      // 4) Title Text Layer
      drawTextLayer('title');

      // 5) Subtitle Text Layer (TOP)
      drawTextLayer('subtitle');
    }

    function drawTextLayer(which){
      const t = state[which];
      if(!t.text && t.text !== "") return;

      // Update rect for hit testing
      const rect = updateTextRect(which);

      // Background box
      const bgAlpha = parseBgTransToAlpha(t.bgTrans);
      if(bgAlpha > 0){
        ctx.save();
        ctx.fillStyle = rgba(t.bgColor, bgAlpha);
        roundRect(ctx, rect.x, rect.y, rect.w, rect.h, Math.max(10, Math.round(t.size * 0.22)));
        ctx.fill();
        ctx.restore();
      }

      // Text
      ctx.save();
      ctx.font = `${t.size}px ${t.font}`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = t.color;
      ctx.fillText(t.text, t.x, t.y);
      ctx.restore();
    }

    function roundRect(c, x, y, w, h, r){
      const rr = Math.max(0, Math.min(r, Math.min(w,h)/2));
      c.beginPath();
      c.moveTo(x+rr, y);
      c.arcTo(x+w, y, x+w, y+h, rr);
      c.arcTo(x+w, y+h, x, y+h, rr);
      c.arcTo(x, y+h, x, y, rr);
      c.arcTo(x, y, x+w, y, rr);
      c.closePath();
    }

    // ====== File loading (Safari safe) ======
    function loadImageFromFile(file, onLoad){
      const url = URL.createObjectURL(file);
      const img = new Image();
      // no crossOrigin needed for local object URLs
      img.onload = function(){
        URL.revokeObjectURL(url);
        onLoad(img);
      };
      img.onerror = function(){
        URL.revokeObjectURL(url);
        toast('Failed to load image');
      };
      img.src = url;
    }

    // ====== Dragging (Pointer Events: mouse + touch) ======
    function pickDragTarget(px, py){
      // Priority: Main > Title > Subtitle (as requested)
      const mainR = mainDrawRect();
      if(mainR && pointInRect(px, py, mainR)){
        return 'main';
      }
      // then title
      updateTextRect('title');
      if(state.title.text && pointInRect(px, py, state.title.rect)){
        return 'title';
      }
      // then subtitle
      updateTextRect('subtitle');
      if(state.subtitle.text && pointInRect(px, py, state.subtitle.rect)){
        return 'subtitle';
      }
      return null;
    }

    canvas.addEventListener('pointerdown', (ev)=>{
      const p = getCanvasPointFromEvent(ev);
      const target = pickDragTarget(p.x, p.y);
      if(!target) return;

      state.dragging.active = true;
      state.dragging.target = target;
      state.dragging.pointerId = ev.pointerId;
      state.dragging.startX = p.x;
      state.dragging.startY = p.y;

      if(target === 'main'){
        state.dragging.origX = state.main.x;
        state.dragging.origY = state.main.y;
      }else{
        state.dragging.origX = state[target].x;
        state.dragging.origY = state[target].y;
      }

      canvas.setPointerCapture(ev.pointerId);
      ev.preventDefault();
    }, { passive: false });

    canvas.addEventListener('pointermove', (ev)=>{
      if(!state.dragging.active) return;
      if(state.dragging.pointerId !== ev.pointerId) return;

      const p = getCanvasPointFromEvent(ev);
      const dx = p.x - state.dragging.startX;
      const dy = p.y - state.dragging.startY;

      const target = state.dragging.target;
      if(target === 'main'){
        state.main.x = state.dragging.origX + dx;
        state.main.y = state.dragging.origY + dy;
      }else if(target === 'title' || target === 'subtitle'){
        state[target].x = state.dragging.origX + dx;
        state[target].y = state.dragging.origY + dy;
      }

      render();
      ev.preventDefault();
    }, { passive: false });

    function endDrag(ev){
      if(!state.dragging.active) return;
      if(state.dragging.pointerId !== ev.pointerId) return;
      state.dragging.active = false;
      state.dragging.target = null;
      state.dragging.pointerId = null;
      toast('Moved');
      ev.preventDefault();
    }
    canvas.addEventListener('pointerup', endDrag, { passive: false });
    canvas.addEventListener('pointercancel', endDrag, { passive: false });

    // ====== UI bindings ======
    function syncUIFromState(){
      ui.bgFit.value = state.bg.fit;
      ui.bgTrans.value = state.bg.transparency;
      ui.bgTransVal.textContent = `${state.bg.transparency}%`;

      ui.mainTrans.value = state.main.transparency;
      ui.mainTransVal.textContent = `${state.main.transparency}%`;
      ui.mainScale.value = state.main.scalePct;
      ui.mainScaleVal.textContent = `${state.main.scalePct}%`;

      ui.frameColor.value = state.frame.color;
      ui.frameThickness.value = state.frame.thickness;
      ui.frameThickVal.textContent = `${state.frame.thickness}`;
      ui.framePad.value = state.frame.pad;
      ui.framePadVal.textContent = `${state.frame.pad}`;
      ui.frameOn.value = state.frame.on ? 'on' : 'off';

      ui.titleText.value = state.title.text;
      ui.titleFont.value = state.title.font;
      ui.titleSize.value = state.title.size;
      ui.titleColor.value = state.title.color;
      ui.titleBgColor.value = state.title.bgColor;
      ui.titleBgTrans.value = state.title.bgTrans;
      ui.titleBgTransVal.textContent = `${state.title.bgTrans}%`;

      ui.subtitleText.value = state.subtitle.text;
      ui.subtitleFont.value = state.subtitle.font;
      ui.subtitleSize.value = state.subtitle.size;
      ui.subtitleColor.value = state.subtitle.color;
      ui.subtitleBgColor.value = state.subtitle.bgColor;
      ui.subtitleBgTrans.value = state.subtitle.bgTrans;
      ui.subtitleBgTransVal.textContent = `${state.subtitle.bgTrans}%`;

      ui.canvasW.value = canvas.width;
      ui.canvasH.value = canvas.height;
    }

    function setStatus(el, loaded, extra){
      el.textContent = loaded ? (extra || 'Loaded') : 'Not loaded';
      el.style.color = loaded ? '#d6ffe9' : 'rgba(233,238,252,.70)';
      el.style.borderColor = loaded ? 'rgba(39,217,163,.35)' : 'rgba(255,255,255,.12)';
    }

    // Background controls
    ui.bgFile.addEventListener('change', ()=>{
      const f = ui.bgFile.files && ui.bgFile.files[0];
      if(!f) return;
      loadImageFromFile(f, (img)=>{
        state.bg.img = img;
        setStatus(ui.bgStatus, true, 'Loaded');
        // Keep smart default positions / sizes
        computeSmartDefaults();
        toast('Background loaded');
      });
    });

    ui.bgFit.addEventListener('change', ()=>{
      state.bg.fit = ui.bgFit.value;
      render();
    });

    ui.bgTrans.addEventListener('input', ()=>{
      state.bg.transparency = parseInt(ui.bgTrans.value, 10);
      ui.bgTransVal.textContent = `${state.bg.transparency}%`;
      render();
    });

    ui.bgClear.addEventListener('click', ()=>{
      state.bg.img = null;
      ui.bgFile.value = '';
      setStatus(ui.bgStatus, false);
      render();
      toast('Background cleared');
    });

    ui.bgAutoTheme.addEventListener('click', ()=>{
      // Quick "Christmas-like" feel without any external assets:
      // Adjust frame color, and text colors + backgrounds
      state.frame.color = '#ffffff';
      state.frame.thickness = clamp(state.frame.thickness, 10, 22);
      state.title.color = '#ffffff';
      state.subtitle.color = '#ffffff';
      state.title.bgColor = '#b3001b'; // festive red
      state.subtitle.bgColor = '#0b6b3a'; // festive green
      state.title.bgTrans = 35;
      state.subtitle.bgTrans = 45;
      state.title.font = FONT_OPTIONS[0].value;
      state.subtitle.font = FONT_OPTIONS[0].value;
      syncUIFromState();
      render();
      toast('Holiday preset applied');
    });

    // Main controls
    ui.mainFile.addEventListener('change', ()=>{
      const f = ui.mainFile.files && ui.mainFile.files[0];
      if(!f) return;
      loadImageFromFile(f, (img)=>{
        state.main.img = img;
        setStatus(ui.mainStatus, true, 'Loaded');
        computeMainBaseSize();
        // Auto-center on load
        state.main.x = canvas.width/2;
        state.main.y = canvas.height/2;
        // Smart defaults
        computeSmartDefaults();
        toast('Main image loaded');
      });
    });

    ui.mainTrans.addEventListener('input', ()=>{
      state.main.transparency = parseInt(ui.mainTrans.value, 10);
      ui.mainTransVal.textContent = `${state.main.transparency}%`;
      render();
    });

    ui.mainScale.addEventListener('input', ()=>{
      state.main.scalePct = parseInt(ui.mainScale.value, 10);
      ui.mainScaleVal.textContent = `${state.main.scalePct}%`;
      render();
    });

    ui.mainCenter.addEventListener('click', ()=>{
      state.main.x = canvas.width/2;
      state.main.y = canvas.height/2;
      render();
      toast('Main centered');
    });

    ui.mainClear.addEventListener('click', ()=>{
      state.main.img = null;
      ui.mainFile.value = '';
      setStatus(ui.mainStatus, false);
      render();
      toast('Main cleared');
    });

    // Frame controls
    ui.frameColor.addEventListener('input', ()=>{
      state.frame.color = ui.frameColor.value;
      render();
    });
    ui.frameThickness.addEventListener('input', ()=>{
      state.frame.thickness = parseInt(ui.frameThickness.value, 10);
      ui.frameThickVal.textContent = `${state.frame.thickness}`;
      render();
    });
    ui.framePad.addEventListener('input', ()=>{
      state.frame.pad = parseInt(ui.framePad.value, 10);
      ui.framePadVal.textContent = `${state.frame.pad}`;
      render();
    });
    ui.frameOn.addEventListener('change', ()=>{
      state.frame.on = (ui.frameOn.value === 'on');
      render();
    });

    // Title controls
    ui.titleText.addEventListener('input', ()=>{
      state.title.text = ui.titleText.value;
      render();
    });
    ui.titleFont.addEventListener('change', ()=>{
      state.title.font = ui.titleFont.value;
      render();
    });
    ui.titleSize.addEventListener('input', ()=>{
      state.title.size = clamp(parseInt(ui.titleSize.value || '14', 10), 14, 800);
      ui.titleSize.value = state.title.size;
      render();
    });
    ui.titleColor.addEventListener('input', ()=>{
      state.title.color = ui.titleColor.value;
      render();
    });
    ui.titleBgColor.addEventListener('input', ()=>{
      state.title.bgColor = ui.titleBgColor.value;
      render();
    });
    ui.titleBgTrans.addEventListener('input', ()=>{
      state.title.bgTrans = parseInt(ui.titleBgTrans.value, 10);
      ui.titleBgTransVal.textContent = `${state.title.bgTrans}%`;
      render();
    });
    ui.titleCenter.addEventListener('click', ()=>{
      state.title.x = canvas.width/2;
      state.title.y = Math.round(canvas.height * 0.15);
      render();
      toast('Title centered');
    });

    // Subtitle controls
    ui.subtitleText.addEventListener('input', ()=>{
      state.subtitle.text = ui.subtitleText.value;
      render();
    });
    ui.subtitleFont.addEventListener('change', ()=>{
      state.subtitle.font = ui.subtitleFont.value;
      render();
    });
    ui.subtitleSize.addEventListener('input', ()=>{
      state.subtitle.size = clamp(parseInt(ui.subtitleSize.value || '14', 10), 14, 800);
      ui.subtitleSize.value = state.subtitle.size;
      render();
    });
    ui.subtitleColor.addEventListener('input', ()=>{
      state.subtitle.color = ui.subtitleColor.value;
      render();
    });
    ui.subtitleBgColor.addEventListener('input', ()=>{
      state.subtitle.bgColor = ui.subtitleBgColor.value;
      render();
    });
    ui.subtitleBgTrans.addEventListener('input', ()=>{
      state.subtitle.bgTrans = parseInt(ui.subtitleBgTrans.value, 10);
      ui.subtitleBgTransVal.textContent = `${state.subtitle.bgTrans}%`;
      render();
    });
    ui.subtitleCenter.addEventListener('click', ()=>{
      state.subtitle.x = canvas.width/2;
      state.subtitle.y = Math.round(canvas.height * 0.24);
      render();
      toast('Subtitle centered');
    });

    // Presets / Random style
    ui.applyPreset.addEventListener('click', ()=>{
      const v = ui.presetCaptions.value;
      if(!v){ toast('Pick a preset first'); return; }
      const parts = v.split('|');
      const t = parts[0] || '';
      const s = parts[1] || '';

      const target = ui.presetTarget.value;
      if(target === 'both'){
        state.title.text = t;
        state.subtitle.text = s;
      }else if(target === 'title'){
        state.title.text = t;
      }else{
        state.subtitle.text = s;
      }

      syncUIFromState();
      render();
      toast('Preset applied');
    });

    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function randColor(){
      // bias toward bright readable colors
      const palette = ['#ffffff','#f6f0ff','#ffe8e8','#e9fff7','#fff4d6','#dbe6ff','#ffd9f5','#e0f0ff'];
      return palette[randInt(0,palette.length-1)];
    }
    function randBgColor(){
      const palette = ['#000000','#0b1a33','#0f2a2a','#2a0f1d','#1b2a0f','#2a1b0f','#121212'];
      return palette[randInt(0,palette.length-1)];
    }

    ui.randomStyle.addEventListener('click', ()=>{
      // Randomize fonts (from required list), sizes, colors
      const f1 = FONT_OPTIONS[randInt(0, FONT_OPTIONS.length-1)].value;
      const f2 = FONT_OPTIONS[randInt(0, FONT_OPTIONS.length-1)].value;

      state.title.font = f1;
      state.subtitle.font = f2;

      const base = Math.min(canvas.width, canvas.height);
      state.title.size = clamp(randInt(Math.round(base*0.06), Math.round(base*0.11)), 14, 800);
      state.subtitle.size = clamp(randInt(Math.round(base*0.03), Math.round(base*0.07)), 14, 800);

      state.title.color = randColor();
      state.subtitle.color = randColor();

      state.title.bgColor = randBgColor();
      state.subtitle.bgColor = randBgColor();

      state.title.bgTrans = randInt(15, 85);
      state.subtitle.bgTrans = randInt(15, 85);

      // Frame tweaks
      state.frame.color = randColor();
      state.frame.thickness = clamp(randInt(6, 26), 1, 80);
      state.frame.pad = clamp(randInt(10, 50), 0, 120);

      // Background transparency tweak
      state.bg.transparency = clamp(randInt(25, 65), 20, 100);

      syncUIFromState();
      render();
      toast('Random style');
    });

    // Canvas settings
    ui.applyCanvasSize.addEventListener('click', ()=>{
      const w = clamp(parseInt(ui.canvasW.value || '1080', 10), 256, 6000);
      const h = clamp(parseInt(ui.canvasH.value || '1080', 10), 256, 6000);
      setCanvasSize(w, h);
      computeSmartDefaults();
      toast(`Canvas ${w}√ó${h}`);
    });

    ui.snapSquare.addEventListener('click', ()=>{
      ui.canvasW.value = 1080;
      ui.canvasH.value = 1080;
      setCanvasSize(1080, 1080);
      computeSmartDefaults();
      toast('Canvas 1080√ó1080');
    });

    // Reset
    ui.resetAll.addEventListener('click', ()=>{
      // keep timestamp; reset state
      state.bg.img = null;
      state.bg.fit = 'cover';
      state.bg.transparency = 35;

      state.main.img = null;
      state.main.transparency = 20;
      state.main.scalePct = 100;
      state.main.x = canvas.width/2;
      state.main.y = canvas.height/2;
      state.main.baseW = 0;
      state.main.baseH = 0;

      state.frame.on = true;
      state.frame.color = '#ffffff';
      state.frame.thickness = 14;
      state.frame.pad = 24;

      state.title.text = 'Merry Christmas';
      state.title.font = FONT_OPTIONS[0].value;
      state.title.size = clamp(Math.round(Math.min(canvas.width, canvas.height) * 0.085), 14, 800);
      state.title.color = '#ffffff';
      state.title.bgColor = '#000000';
      state.title.bgTrans = 70;
      state.title.x = canvas.width/2;
      state.title.y = Math.round(canvas.height * 0.15);

      state.subtitle.text = 'Warmest Wishes';
      state.subtitle.font = FONT_OPTIONS[0].value;
      state.subtitle.size = clamp(Math.round(Math.min(canvas.width, canvas.height) * 0.045), 14, 800);
      state.subtitle.color = '#ffffff';
      state.subtitle.bgColor = '#000000';
      state.subtitle.bgTrans = 78;
      state.subtitle.x = canvas.width/2;
      state.subtitle.y = Math.round(canvas.height * 0.24);

      ui.bgFile.value = '';
      ui.mainFile.value = '';
      setStatus(ui.bgStatus, false);
      setStatus(ui.mainStatus, false);

      syncUIFromState();
      render();
      toast('Reset');
    });

    // Copy Settings (helpful for sharing)
    ui.copyInfo.addEventListener('click', async ()=>{
      const payload = {
        generated_at: GENERATION_TS,
        canvas: { w: canvas.width, h: canvas.height },
        bg: { loaded: !!state.bg.img, fit: state.bg.fit, transparency: state.bg.transparency },
        main: { loaded: !!state.main.img, transparency: state.main.transparency, scalePct: state.main.scalePct, x: Math.round(state.main.x), y: Math.round(state.main.y) },
        frame: { on: state.frame.on, color: state.frame.color, thickness: state.frame.thickness, pad: state.frame.pad },
        title: { text: state.title.text, font: state.title.font, size: state.title.size, color: state.title.color, bgColor: state.title.bgColor, bgTrans: state.title.bgTrans, x: Math.round(state.title.x), y: Math.round(state.title.y) },
        subtitle: { text: state.subtitle.text, font: state.subtitle.font, size: state.subtitle.size, color: state.subtitle.color, bgColor: state.subtitle.bgColor, bgTrans: state.subtitle.bgTrans, x: Math.round(state.subtitle.x), y: Math.round(state.subtitle.y) },
        layer_order: ["Background Image Layer","Main Image Layer","Frame / Border Layer","Title Text Layer","Subtitle Text Layer"]
      };
      const text = JSON.stringify(payload, null, 2);
      try{
        await navigator.clipboard.writeText(text);
        toast('Settings copied');
        ui.copyDump.style.display = 'none';
      }catch(e){
        // Fallback: show in UI
        ui.copyDump.style.display = 'block';
        ui.copyDump.textContent = text;
        toast('Copy blocked ‚Äî shown below');
      }
    });

    // Export
    function downloadPNG(){
      // Ensure latest render
      render();

      const safeTs = GENERATION_TS.replace(/[: ]/g,'-');
      const filename = `framed-${safeTs}.png`;

      try{
        const url = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        toast('Downloading PNG');
      }catch(err){
        // iOS Safari sometimes blocks auto-download
        toast('Export blocked ‚Äî try screenshot / share');
      }
    }
    ui.downloadPng.addEventListener('click', downloadPNG);
    ui.downloadPng2.addEventListener('click', downloadPNG);

    // ====== Initial statuses + defaults ======
    setStatus(ui.bgStatus, false);
    setStatus(ui.mainStatus, false);

    // Keep UI labels synced
    function bindLabelRange(rangeEl, labelEl, fmt){
      rangeEl.addEventListener('input', ()=>{
        labelEl.textContent = fmt(rangeEl.value);
      });
      labelEl.textContent = fmt(rangeEl.value);
    }
    bindLabelRange(ui.bgTrans, ui.bgTransVal, v => `${v}%`);
    bindLabelRange(ui.mainTrans, ui.mainTransVal, v => `${v}%`);
    bindLabelRange(ui.mainScale, ui.mainScaleVal, v => `${v}%`);
    bindLabelRange(ui.frameThickness, ui.frameThickVal, v => `${v}`);
    bindLabelRange(ui.framePad, ui.framePadVal, v => `${v}`);
    bindLabelRange(ui.titleBgTrans, ui.titleBgTransVal, v => `${v}%`);
    bindLabelRange(ui.subtitleBgTrans, ui.subtitleBgTransVal, v => `${v}%`);

    // Smart defaults on load
    setCanvasSize(1080, 1080);
    computeSmartDefaults();
    syncUIFromState();
    render();

    // Responsive re-render on resize (for crisp interactions; export unaffected)
    window.addEventListener('resize', ()=>{ render(); });

  })();
  </script>
</body>
</html>
